## Trabajo Práctico 6 - Pruebas Unitarias

### 4- Desarrollo:
#### Prerequisitos:
- Node.js
  - Para MAC OS:
    - Instalar Brew https://brew.sh/
    - Correr: 
    ```bash
    # NOTE:
    # Homebrew is not a Node.js package manager.
    # Please ensure it is already installed on your system.
    # Follow official instructions at https://brew.sh/
    # Homebrew only supports installing major Node.js versions and might not support the latest Node.js version from the 20 release line.
    
    # download and install Node.js
    brew install node@20
    
    # verifies the right Node.js version is in the environment
    node -v # should print `v20.17.0`
    
    # verifies the right npm version is in the environment
    npm -v # should print `10.8.2`
    ```
  - Para Windows:
    - Instalar Chocolatey https://chocolatey.org/
    - Correr: 
    ```bash
    # NOTE:
    # Chocolatey is not a Node.js package manager.
    # Please ensure it is already installed on your system.
    # Follow official instructions at https://chocolatey.org/
    # Chocolatey is not officially maintained by the Node.js project and might not support the v20.17.0 version of Node.js
    
    # download and install Node.js
    choco install nodejs-lts --version="20.17.0"
    
    # verifies the right Node.js version is in the environment
    node -v # should print `20`
    
    # verifies the right npm version is in the environment
    npm -v # should print `10.8.2`
      ```
- Angular CLI
    ```bash
     npm install -g @angular/cli
     ```
- .NET Core 8 SDK https://dotnet.microsoft.com/en-us/download/dotnet/8.0

![Descripción de la imagen](imagen1.png)
  
#### 4.1 Creación de una BD SQL Server para nuestra App
A\. Crear una BD Azure SQL Database (Ver Instructivo 5.1) o montar una imagen Docker de SQL Server como se solicitó en el punto 12 del [TP02]. (https://github.com/ingsoft3ucc/TPS_2024/blob/main/trabajos/02-introduccion-docker.md)

![Descripción de la imagen](imagen2.png)
![Descripción de la imagen](imagen3.png)
![Descripción de la imagen](imagen4.png)
![Descripción de la imagen](imagen5.png)
![Descripción de la imagen](imagen6.png)
![Descripción de la imagen](imagen7.png)
![Descripción de la imagen](imagen8.png)
![Descripción de la imagen](imagen9.png)
![Descripción de la imagen](imagen10.png)

B\. En caso de optar por la opción de montar la imagen de docker, una vez levantada el contenedor, conectarse y ejecutar el siguiente script:
```sql

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Employees](
    [Id] [int] IDENTITY(1,1) NOT NULL,
    [Name] [nvarchar](max) NULL,
    [CreatedDate] [datetime2](7) NOT NULL,
 CONSTRAINT [PK_Employees] PRIMARY KEY CLUSTERED 
(
    [Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET IDENTITY_INSERT [dbo].[Employees] ON 
GO
INSERT [dbo].[Employees] ([Id], [Name], [CreatedDate]) VALUES (1, N'Juan Perez', CAST(N'2024-09-05T00:00:00.0000000' AS DateTime2))
GO
INSERT [dbo].[Employees] ([Id], [Name], [CreatedDate]) VALUES (2, N'Carla Ruiz', CAST(N'2024-09-05T22:22:47.4405720' AS DateTime2))
GO
INSERT [dbo].[Employees] ([Id], [Name], [CreatedDate]) VALUES (3, N'Carlos Gomez', CAST(N'2024-09-06T09:16:50.0709430' AS DateTime2))
GO
INSERT [dbo].[Employees] ([Id], [Name], [CreatedDate]) VALUES (4, N'Joaquin Zarate', CAST(N'2024-09-06T09:19:37.8987160' AS DateTime2))
GO
INSERT [dbo].[Employees] ([Id], [Name], [CreatedDate]) VALUES (5, N'Luis Rodriguez', CAST(N'2024-09-06T09:23:31.3244340' AS DateTime2))
GO
SET IDENTITY_INSERT [dbo].[Employees] OFF
GO


```
#### 4.2 Obtener nuestra App
A\. Clonar el repo https://github.com/ingsoft3ucc/Angular_WebAPINetCore8_CRUD_Sample.git

![Descripción de la imagen](imagen11.png)

B\. Seguir las instrucciones del README.md del repo clonado prestando atención a la modificación de la cadena de conexión en el appSettings.json para que apunte a la BD creada en 4.1 

![Descripción de la imagen](imagen12.png)
![Descripción de la imagen](imagen13.png)

C\. Navegar a http://localhost:7150/swagger/index.html y probar uno de los controladores para verificar el correcto funcionamiento de la API.
![image](https://github.com/user-attachments/assets/a537ad2e-7c4a-4099-a3e4-fb03fc3bd1f1)

![Descripción de la imagen](imagen14.png)
![Descripción de la imagen](imagen15.png)

D\. Navegar a http://localhost:4200 y verificar el correcto funcionamiento de nuestro front-end Angular
![image](https://github.com/user-attachments/assets/a2858f8a-4ce7-4d49-8852-167e8cc23660)

![Descripción de la imagen](imagen17.png)
![Descripción de la imagen](imagen16.png)
![Descripción de la imagen](imagen18.png)

E\. Una vez verificado el correcto funcionamiento de la Aplicación procederemos a crear un proyecto de pruebas unitarias para nuestra API.

#### 4.3 Crear Pruebas Unitarias para nuestra API
A\. En el directorio raiz de nuestro repo crear un nuevo proyecto de pruebas unitarias para nuestra API 
```bash
dotnet new xunit -n EmployeeCrudApi.Tests
```
![image](https://github.com/user-attachments/assets/faba2065-cf36-44c8-be66-c616355b7659)

![Descripción de la imagen](imagen19.png)

B\. Instalar dependencias necesarias
![Descripción de la imagen](imagen20.png)
![Descripción de la imagen](imagen21.png)

C\. Editar archivo UnitTest1.cs reemplazando su contenido por

![Descripción de la imagen](imagen22.png)


D\. Renombrar archivo UnitTest1.cs por EmployeeControllerUnitTests.cs
```bash
mv UnitTest1.cs EmployeeControllerUnitTests.cs 
```
![Descripción de la imagen](imagen23.png)
![Descripción de la imagen](imagen24.png)

E\. Editar el archivo EmployeeCrudApi.Tests/EmployeeCrudApi.Tests.csproj para agregar una referencia a nuestro proyecto de EmployeeCrudApi reemplazando su contenido por
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>

    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="coverlet.collector" Version="6.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="8.0.8" />
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.8.0" />
    <PackageReference Include="Moq" Version="4.20.71" />
    <PackageReference Include="xunit" Version="2.9.0" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.5.3" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="../EmployeeCrudApi/EmployeeCrudApi/EmployeeCrudApi.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Using Include="Xunit" />
  </ItemGroup>

</Project>

```
![Descripción de la imagen](imagen25.png)

F\. Ejecutar los siguientes comandos para ejecutar nuestras pruebas
```bash
dotnet build
dotnet test
```
![Descripción de la imagen](imagen26.png)
![Descripción de la imagen](imagen27.png)

G\. Verificar que se hayan ejecutado correctamente las pruebas

![image](https://github.com/user-attachments/assets/5f69e693-ed99-418b-97c1-c69ebd5839fe)

H\. Verificar que no estamos usando una dependencia externa como la base de datos.

I\. Modificar la cadena de conexión en el archivo appsettings.json para que use un usuario o password incorrecto y recompilar el proyecto EmployeeCrudApi

![Descripción de la imagen](imagen28.png)

```bash
dotnet build
dotnet run --urls "http://localhost:7150"
```
J\. Verificar que nuestro proyecto ya no tiene acceso a la BD navegando a http://localhost:7150/swagger/index.html y probando uno de los controladores:
![Descripción de la imagen](imagen29.png)
![Descripción de la imagen](imagen30.png)
![image](https://github.com/user-attachments/assets/33df73ea-bd02-48a6-a399-c4a312c1e360)

K\. En la carpeta de nuestro proyecto EmployeeCrudApi.Tests volver a correr las pruebas
```bash
dotnet build
dotnet test
```
L\. Verificar que se hayan ejecutado correctamente las pruebas inclusive sin tener acceso a la BD, lo que confirma que es efectivamente un conjunto de pruebas unitarias que no requieren de una dependencia externa para funcionar.
![image](https://github.com/user-attachments/assets/5f69e693-ed99-418b-97c1-c69ebd5839fe)

![Descripción de la imagen](imagen31.png)

M\. Modificar la cadena de conexión en el archivo appsettings.json para que use el usuario y password correcto y recompilar el proyecto EmployeeCrudApi
```bash
dotnet build
dotnet run --urls "http://localhost:7150"
```

![Descripción de la imagen](imagen32.png)

N\. Verificar que nuestro proyecto vuelve a tener acceso a la BD navegando a http://localhost:7150/swagger/index.html y probando uno de los controladores:
![image](https://github.com/user-attachments/assets/2fe6b621-db7b-48f2-96e8-d8e1b995474f)

![Descripción de la imagen](imagen33.png)
![Descripción de la imagen](imagen34.png)

#### 4.4 Creamos pruebas unitarias para nuestro front de Angular:
Intro\. 


A\. Nos posicionamos en nuestro proyecto de front, en el directorio EmployeeCrudAngular/src/app
```bash
pwd
```
![image](https://github.com/user-attachments/assets/1057289a-4d31-485b-8502-cfb817a53453)

![Descripción de la imagen](imagen35.png)

B\. Editamos el archivo app.component.spec.ts reemplazando su contenido por:

![Descripción de la imagen](imagen36.png)

C\. Creamos el archivo employee.service.spec.ts reemplazando su contenido por:

![Descripción de la imagen](imagen37.png)


E\. Editamos el archivo addemployee.component.spec.ts ubicado en la carpeta **addemployee** reemplazando su contenido por:

![Descripción de la imagen](imagen40.png)


F\. En el directorio raiz de nuestro proyecto EmployeeCrudAngular ejecutamos el comando 
```bash
ng test
```
![Descripción de la imagen](imagen39.png)
En proyectos de Angular, Jasmine se usa para escribir las pruebas, y Karma se encarga de ejecutarlas. Cuando ejecutamos el comando ng test, Karma se inicia, carga las pruebas escritas en Jasmine, y las ejecuta en un navegador.

G\. Vemos que se abre una ventana de Karma con Jasmine en la que nos indica que los tests se ejecutaron correctamente

![Descripción de la imagen](imagen41.png)
![image](https://github.com/user-attachments/assets/d5bd574f-bab4-4f65-ac5e-6b95d6338bc3)

H\. Vemos que los tests se ejecutaron correctamente:
![image](https://github.com/user-attachments/assets/24172199-9b90-4e1c-8231-3c142f9d6160)

![Descripción de la imagen](imagen42.png)

I\. Verificamos que no esté corriendo nuestra API navegando a http://localhost:7150/swagger/index.html y recibiendo esta salida:
![image](https://github.com/user-attachments/assets/550dd212-5254-4c7f-bea0-aa55c73021fe)

![Descripción de la imagen](imagen43.png)

J\. Los puntos G y H nos indican que se han ejecutado correctamente las pruebas inclusive sin tener acceso a la API, lo que confirma que es efectivamente un conjunto de pruebas unitarias que no requieres de una dependencia externa para funcionar.

#### 4.5 Agregamos generación de reporte XML de nuestras pruebas de front.
Para cuando integremos nuestras pruebas en un pipeline de Build, vamos a necesitar el resultado devuelto por nuestras pruebas para reportarlas junto a las pruebas de back que se reportan automaticamente. 

![image](https://github.com/user-attachments/assets/12c430fd-13e7-4370-8c2a-a2f2756bd33f)


Haremos los siguientes pasos para prepararnos:

A\. Instalamos dependencia karma-junit-reporter
```bash
npm install karma-junit-reporter --save-dev
```
![Descripción de la imagen](imagen44.png)

B\. En el directorio raiz de nuestro proyecto (al mismo nivel que el archivo angular.json) creamos un archivo karma.conf.js con el siguiente contenido

![Descripción de la imagen](imagen45.png)


C\. Ejecutamos nuestros test de la siguiente manera:
```bash
ng test --karma-config=karma.conf.js --watch=false --browsers ChromeHeadless
```

![Descripción de la imagen](imagen46.png)

D\. Verificamos que se creo un archivo test-result.xml en el directorio test-results que está al mismo nivel que el directorio src

![Descripción de la imagen](imagen47.png)

#### 4.6 Modificamos el código de nuestra API y creamos nuevas pruebas unitarias:

A\. Realizar al menos 5 de las siguientes modificaciones sugeridas al código de la API:
![Descripción de la imagen](imagen48.png)
![Descripción de la imagen](imagen49.png)
![Descripción de la imagen](imagen50.png)

B\. Crear las pruebas unitarias necesarias para validar las modificaciones realizadas en el código

![Descripción de la imagen](imagen51.png)
![Descripción de la imagen](imagen52.png)
![Descripción de la imagen](imagen53.png)


#### 4.7 Modificamos el código de nuestro Front y creamos nuevas pruebas unitarias:

A\. Realizar en el código del front las mismas modificaciones hechas a la API. 

![Descripción de la imagen](imagen54.png)
![Descripción de la imagen](imagen55.png)
![Descripción de la imagen](imagen56.png)
![Descripción de la imagen](imagen57.png)
![Descripción de la imagen](imagen58.png)
![Descripción de la imagen](imagen60.png)
![Descripción de la imagen](imagen61.png)
![Descripción de la imagen](imagen62.png)

B\. Las validaciones deben ser realizadas en el front sin llegar a la API, y deben ser mostradas en un toast como por ejemplo https://stackblitz.com/edit/angular12-toastr?file=src%2Fapp%2Fapp.component.ts o https://stackblitz.com/edit/angular-error-toast?file=src%2Fapp%2Fcore%2Frxjsops.ts


C\. Crear las pruebas unitarias necesarias en el front para validar las modificaciones realizadas en el código del front.

![Descripción de la imagen](imagen59.png)
![Descripción de la imagen](imagen60.png)
![Descripción de la imagen](imagen63.png)
